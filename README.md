# 🎯 A股B1策略选股系统

基于mootdx的A股全市场数据获取和B1选股策略系统，支持本地数据存储、自动更新和通达信板块文件生成。

## ✨ 主要功能

- 🔄 **全市场数据获取**: 自动获取A股市场所有股票数据
- 📅 **智能数据管理**: 按日期标签存储，自动判断是否需要更新
- 🎯 **B1选股策略**: 基于KDJ、涨跌幅、振幅和知行线的专业选股策略
- 💾 **本地数据存储**: 支持数据本地缓存，提高运行效率
- 📊 **通达信兼容**: 生成.blk格式文件，可直接导入通达信
- 🔧 **参数化配置**: 支持自定义知行多空线参数

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install -r requirements.txt
```

### 2. 使用快速启动脚本

```bash
# 给脚本执行权限
chmod +x run.sh

# 运行
./run.sh
```

### 3. 命令行使用

#### 🌍 全市场分析（默认推荐）
```bash
# 全市场B1选股（分析所有A股，默认行为）
python main.py

# 先下载全市场数据再选股（推荐）
python main.py --download-first --all-stocks

# 使用本地数据进行全市场分析
python main.py --use-local --all-stocks
```

#### 🧪 测试和限量分析
```bash
# 测试模式（仅分析前100只股票）
python main.py --test-mode

# 限量分析（指定股票数量）
python main.py --stock-count 500

# 自定义知行多空线参数
python main.py --m1 14 --m2 28 --m3 57 --m4 114
```

#### 📥 数据管理
```bash
# 下载全市场数据（所有A股）
python download_market_data.py

# 测试下载（前100只股票）
python download_market_data.py --test

# 强制更新数据
python download_market_data.py --force

# 查看数据统计
python download_market_data.py --stats
```

## 🚀 多线程加速功能

### 🔧 多线程参数配置

系统支持多线程并发下载，大幅提升数据获取速度：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--max-workers` | 10 | 最大线程数，建议5-20之间 |
| `--batch-size` | 50 | 批处理大小，每批股票数量 |

### ⚡ 性能对比

| 模式 | 速度 | 适用场景 |
|------|------|----------|
| 单线程 | ~2-3只/秒 | 小量测试、稳定网络 |
| 多线程(5线程) | ~12只/秒 | 日常使用 |
| 多线程(10线程) | ~15-20只/秒 | 快速全量下载 |
| 多线程(15线程) | ~20-25只/秒 | 高速网络环境 |

### 📝 使用示例

```bash
# 快速下载测试（5线程）
python3 download_market_data.py --test --max-workers 5

# 全市场高速下载（15线程）
python3 download_market_data.py --all-stocks --max-workers 15 --batch-size 30

# B1选股策略（8线程预下载）
python3 main.py --test-mode --max-workers 8

# 启动脚本自动使用多线程
./run.sh  # 选择选项2或9
```

### 🎯 推荐配置

**测试模式**：
- 线程数：5-8
- 批次大小：20-30
- 适用：功能测试、小量数据

**生产模式**：
- 线程数：10-15  
- 批次大小：30-50
- 适用：全市场数据下载

**高速模式**：
- 线程数：15-20
- 批次大小：20-30
- 适用：高速网络、大量数据

### ⚠️ 注意事项

1. **网络环境**：线程数过多可能导致网络拥堵
2. **服务器限制**：过高并发可能被服务器限制
3. **内存使用**：线程数增加会提高内存占用
4. **最佳实践**：建议从小线程数开始测试，逐步调优

## 项目结构

```
stock-analysis/
├── main.py              # 主程序入口
├── requirements.txt     # 依赖包列表
├── README.md           # 项目说明
└── src/
    ├── data_client.py  # 数据接入模块
    └── stock_selector.py # 选股策略模块
```

## 📈 B1选股策略说明

### B1策略筛选条件

B1策略是一个基于技术指标的综合选股策略，包含以下5个核心条件：

1. **KDJ指标条件**: J值 ≤ 13（超卖状态）
2. **涨跌幅控制**: 当日涨幅在 -2% 到 +1.8% 之间
3. **振幅限制**: 当日振幅 ≤ 7%（波动适中）
4. **短期趋势**: 知行短期趋势线 > 知行多空线（短期向上）
5. **价格位置**: 收盘价 > 知行多空线（价格在多空线上方）

### 技术指标计算

- **KDJ指标**:
  - RSV = (CLOSE-LLV(LOW,9))/(HHV(HIGH,9)-LLV(LOW,9))*100
  - K = SMA(RSV,3,1)
  - D = SMA(K,3,1)
  - J = 3*K-2*D

- **知行线指标**:
  - 知行短期趋势线 = EMA(EMA(CLOSE,10),10)
  - 知行多空线 = (MA(M1)+MA(M2)+MA(M3)+MA(M4))/4
  - 默认参数: M1=14, M2=28, M3=57, M4=114

### 输出格式

- **屏幕输出**: 显示选中股票的详细信息和技术指标值
- **BLK文件**: 生成通达信格式的板块文件 `B1_YYYYMMDD_HHMMSS.blk`
- **代码格式**: 7位代码（市场标识+6位股票代码，1=上海，0=深圳）

## 📊 系统输出

### 选股结果展示
系统会输出：
1. 🔍 **市场扫描**: 显示扫描的股票总数和进度
2. 📋 **策略筛选**: 详细显示每个股票的技术指标值和条件检查
3. 📈 **选股结果**: 最终符合B1策略的股票列表
4. 💾 **文件生成**: 自动生成BLK格式文件用于通达信导入

### BLK文件使用
生成的 `B1_YYYYMMDD_HHMMSS.blk` 文件可以直接导入通达信：
1. 打开通达信软件
2. 右键板块列表 → 导入板块
3. 选择生成的BLK文件
4. 导入成功后可在自定义板块中查看

## ⚠️ 重要说明

- **数据来源**: 使用mootdx从A股市场实时获取数据
- **运行时间**: 建议在交易时间运行以获取最新数据
- **全市场分析**: 默认分析所有A股（约4000+只股票），首次运行可能需要较长时间
- **投资建议**: 选股结果仅供参考，投资需谨慎，请结合其他分析方法
- **数据准确性**: 技术指标基于历史数据计算，市场有风险

## 🔧 自定义配置

可通过命令行参数自定义知行多空线参数：
```bash
# 自定义M1、M2、M3、M4参数
python main.py --m1 10 --m2 20 --m3 40 --m4 80
```
